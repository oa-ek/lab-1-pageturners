@using PageTurners.Core.Entities

@model Book

@{
    ViewData["Title"] = "Детальніше про книгу";
}

@{
    <a asp-controller="Book" asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">Редагувати цю книгу</a>
}
<a asp-controller="Book" asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Видалити</a>



<div class="container">
    <h1 class="display-4">Деталі про книгу</h1>
    <hr />

    <div class="row">
        <div class="col-md-6">
            <dl class="row">
                <dt class="col-sm-4">Назва:</dt>
                <dd class="col-sm-8">@Model.Title</dd>

                <dt class="col-sm-4">Автор:</dt>
                <dd class="col-sm-8">@Model.Author</dd>

                <dt class="col-sm-4">Жанр:</dt>
                <dd class="col-sm-8">@Model.Genre</dd>

                <dt class="col-sm-4">Опис:</dt>
                <dd class="col-sm-8">@Model.Desc</dd>

                <dt class="col-sm-4">Видання:</dt>
                <dd class="col-sm-8">@Model.Edition</dd>

                <dt class="col-sm-4">Дата публікації:</dt>
                <dd class="col-sm-8">@Model.DatePubl</dd>
            </dl>
        </div>
    </div>

    <h4>
        Середній рейтинг:
    </h4>
    <h4>
        @Model.AverageRating
    </h4>
   

    <h4>Виставити рейтинг</h4>
    <form asp-controller="Book" asp-action="RateBook" method="post">
        <input type="hidden" asp-for="Id" value="@Model.Id" />
        <div class="form-group">
            <label for="ratingValue">Рейтинг (від 1 до 5):</label>
            <div id="star-rating">
                <span class="star" data-value="1">☆</span>
                <span class="star" data-value="2">☆</span>
                <span class="star" data-value="3">☆</span>
                <span class="star" data-value="4">☆</span>
                <span class="star" data-value="5">☆</span>
            </div>
            <input type="hidden" id="selected-rating" name="ratingValue" />
        </div>
        <button type="submit" class="btn btn-primary">Виставити рейтинг</button>
    </form>


</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const starRating = document.getElementById("star-rating");
        const selectedRating = document.getElementById("selected-rating");

        starRating.addEventListener("click", function (e) {
            const star = e.target;
            if (star.classList.contains("star")) {
                const value = star.getAttribute("data-value");
                selectedRating.value = value;
                updateStarRating(parseInt(value));
            }
        });

        starRating.addEventListener("mouseover", function (e) {
            const star = e.target;
            if (star.classList.contains("star")) {
                const value = star.getAttribute("data-value");
                updateStarRating(parseInt(value));
            }
        });

        starRating.addEventListener("mouseout", function () {
            const value = selectedRating.value;
            if (value) {
                updateStarRating(parseInt(value));
            } else {
                clearStarRating();
            }
        });

        function updateStarRating(value) {
            clearStarRating();
            for (let i = 1; i <= value; i++) {
                const star = starRating.querySelector(`[data-value="${i}"]`);
                star.textContent = "★";
            }
        }

        function clearStarRating() {
            const stars = starRating.querySelectorAll(".star");
            stars.forEach((star) => {
                star.textContent = "☆";
            });
        }
    });
</script>

<h4>Коментарі</h4>
<hr />

@if (Model.Comment != null && Model.Comment.Any())
{
    <ul class="list-group">
        @foreach (var comment in Model.Comment)
        {
            <li class="list-group-item">
            <li class="list-group-item">
                <div>
                        @if (comment.Commentator != null)
                        {
                        <strong>@comment.Commentator.Name</strong>
                            @($"({comment.Date.ToString("dd.MM.yyyy HH:mm")})")
                        }
                        else
                        {
                        <strong>Гість</strong>
                        }
                </div>

            </li>


                <div>
                    @comment.Comment
                </div>
                <div class="comment-star-rating" data-comment-id="@comment.Id">
                    <span class="star comment-star" data-value="1">☆</span>
                    <span class="star comment-star" data-value="2">☆</span>
                    <span class="star comment-star" data-value="3">☆</span>
                    <span class="star comment-star" data-value="4">☆</span>
                    <span class="star comment-star" data-value="5">☆</span>
                    <input type="hidden" class="comment-selected-rating" name="commentRating" />
                </div>
                <div>
                    <form asp-action="DeleteComment" method="post">
                        <input type="hidden" name="commentId" value="@comment.Id" />
                        <button type="submit" class="btn btn-danger">Видалити коментар</button>
                    </form>
                </div>
            </li>
        }
    </ul>
}
else
{
    <p>Коментарі відсутні.</p>
}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const commentStarRatings = document.querySelectorAll(".comment-star-rating");

        commentStarRatings.forEach(function (commentStarRating) {
            commentStarRating.addEventListener("click", function (e) {
                const star = e.target;
                if (star.classList.contains("star")) {
                    const value = star.getAttribute("data-value");
                    const commentId = commentStarRating.getAttribute("data-comment-id");
                    const targetId = `comment-${commentId}`;
                    const commentSelectedRating = document.querySelector(`.${targetId} .comment-selected-rating`);
                    commentSelectedRating.value = value;
                    updateStarRating(parseInt(value), targetId);
                }
            });

            commentStarRating.addEventListener("mouseover", function (e) {
                const star = e.target;
                if (star.classList.contains("star")) {
                    const value = star.getAttribute("data-value");
                    const commentId = commentStarRating.getAttribute("data-comment-id");
                    const targetId = `comment-${commentId}`;
                    updateStarRating(parseInt(value), targetId);
                }
            });

            commentStarRating.addEventListener("mouseout", function () {
                const commentId = commentStarRating.getAttribute("data-comment-id");
                const targetId = `comment-${commentId}`;
                clearStarRating(targetId);
            });
        });

        function updateStarRating(value, targetId) {
            clearStarRating(targetId);
            const targetStarRating = document.querySelector(`.${targetId}`);
            for (let i = 1; i <= value; i++) {
                const star = targetStarRating.querySelector(`[data-value="${i}"]`);
                star.textContent = "★";
            }
        }

        function clearStarRating(targetId) {
            const stars = document.querySelectorAll(`.${targetId} .star`);
            stars.forEach((star) => {
                star.textContent = "☆";
            });
        }
    });
</script>


<h4>Додати коментар</h4>
<form asp-controller="Book" asp-action="AddComment" method="post">
    <input type="hidden" asp-for="Id" value="@Model.Id" />
    <div class="form-group">
        <textarea name="newComment" class="form-control" rows="4"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Додати коментар</button>
</form>


</div>
